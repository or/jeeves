{% extends "base.html" %}
{% block title %}Jeeves - {{ project.name }} - Build #{{ object.build_id }}{% endblock %}

{% block content %}
<div class="container-fluid" style="margin:0.2em">
  {% include "partials/build_detail_header.html" with build=object %}
</div>

<div id="log-view">
</div>
{% endblock %}

{% block js %}
var log_data = JSON.parse('{{ log_data|escapejs }}');
var log_view_component;

swampdragon.onChannelMessage(function (channels, message) {
  var element = $('#build-' + message.data.id);
  var data = message.data;
  console.log(data);
  if (data.details_html != null) {
    $('#build-' + {{ build.id }}).replaceWith(data.details_html);
  }

  if (data.jobs_html != null) {
    $('#jobs-list').replaceWith(data.jobs_html);
  }

  update_progress_bars();
  update_age_displays();
});

swampdragon.ready(function() {
  setInterval(function () {
    swampdragon.callRouter('get_latest_log', 'build-changes',
      {id: {{ build.id }}, offsets: log_data.offsets},
      function(context, data) {
        console.log(data);
        log_data.jobs = data.jobs;

        for (var key in data.offsets) {
          log_data.offsets[key] = data.offsets[key];
          if (log_data.data[key] == null) {
            log_data.data[key] = data.data[key];
          } else {
            log_data.data[key] += data.data[key];
          }
        }

        log_view_component.setLogData(log_data);
      });
  }, 1000);

  swampdragon.subscribe('build-changes', 'build-change-{{ build.id }}', {id: {{ build.id }}});
});

$(document).ready(function() {
  update_progress_bars();
  update_age_displays();
  log_view_component = React.render(
    React.createElement(LogView, {log_data: log_data}),
    $('#log-view').get()[0]
  );
  log_view_component.autoScroll();
});
{% endblock %}
